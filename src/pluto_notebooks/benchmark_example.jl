### A Pluto.jl notebook ###
# v0.19.30

using Markdown
using InteractiveUtils

# ╔═╡ 0bc15b36-b939-11ee-099c-ebcd067bc784
begin
    using Pkg
    NOTEBOOKS_PATH = "src/pluto_notebooks"
    DATA_PATH = "data"  # store generated by notebook data
    @assert endswith(pwd(), NOTEBOOKS_PATH) "Wrong directory!"
    RDR_PATH = "../../.."  # path to the RDR project root
    Pkg.activate(RDR_PATH)

    import RansacDoneRight as RDR
    md"""
    ### Activating RansacDoneRight environment...
    """
end

# ╔═╡ 3d7a9cb6-9bbc-447e-bd1f-7c5a1c780f72
begin
    using Revise
    using LinearAlgebra
    using PlutoUI
end

# ╔═╡ 5be0257e-3037-448f-a3f0-4ea5284cb66e
begin
    using Profile
    using PProf
    using BenchmarkTools
end

# ╔═╡ 89697697-05d5-4748-ac07-a880a067d063
begin
    html"""
    <style>
    	main {
    		margin: 0 auto;
    		max-width: 2000px;
        	padding-left: max(160px, 15%);
        	padding-right: max(160px, 15%);
    	}
    </style>
    """
end

# ╔═╡ 9956f435-8284-47b3-9e04-aac9db0b0098
md"""
# Notebook on the Benchmark example
"""

# ╔═╡ 0162ee03-41b3-4083-b248-11ddf8325c7e
ground_truth_H = [
    1.15 0.1 5;
    0.25 0.9 -10;
    0.0003 0.0005 0.99
]

# ╔═╡ 38db9e4d-3bc4-44c1-b80e-99e3b05d7054
corresps = RDR.generate_k_random_correspondences(1000, ground_truth_H)

# ╔═╡ 2e68d8a2-c996-42e2-8f88-5f7934e8ff64
noise_cov_m = [
    1.0 0.5;
    0.5 1.2
]

# ╔═╡ 376cad66-5df9-4a40-9ab0-27f2b695e900
noised_corresps = RDR.add_noise_to_correspondences(corresps, noise_cov_m, noise_cov_m, true)

# ╔═╡ 7e98bc13-5fb1-4838-8dfc-c0d1d844de37
est_H, est_Σₕ = RDR.get_H_and_covariance(@view noised_corresps[1:4])

# ╔═╡ 50028a80-0d99-4416-8adb-77d68af0655c
some_closure() = RDR.compute_uncertain_residuals(est_H, est_Σₕ, @view noised_corresps[5:end])

# ╔═╡ ac5cf885-aa3c-4ecc-8c1c-240fd67fb9a3
md"""
### Important: running $1$ time for precompilation before benchmarking / profiling.
"""

# ╔═╡ fb528b70-92d1-4895-8832-2367d9578f99
some_closure()

# ╔═╡ 42ab431b-24db-4120-819f-fccba0dcf4b1
@benchmark some_closure()

# ╔═╡ 10a9e4e6-401f-49fb-ade6-2b85f67f4cf1
begin
    @profile some_closure()
    pprof()
end

# ╔═╡ Cell order:
# ╟─0bc15b36-b939-11ee-099c-ebcd067bc784
# ╟─89697697-05d5-4748-ac07-a880a067d063
# ╠═3d7a9cb6-9bbc-447e-bd1f-7c5a1c780f72
# ╟─9956f435-8284-47b3-9e04-aac9db0b0098
# ╠═5be0257e-3037-448f-a3f0-4ea5284cb66e
# ╠═0162ee03-41b3-4083-b248-11ddf8325c7e
# ╠═38db9e4d-3bc4-44c1-b80e-99e3b05d7054
# ╠═2e68d8a2-c996-42e2-8f88-5f7934e8ff64
# ╠═376cad66-5df9-4a40-9ab0-27f2b695e900
# ╠═7e98bc13-5fb1-4838-8dfc-c0d1d844de37
# ╠═50028a80-0d99-4416-8adb-77d68af0655c
# ╟─ac5cf885-aa3c-4ecc-8c1c-240fd67fb9a3
# ╠═fb528b70-92d1-4895-8832-2367d9578f99
# ╠═42ab431b-24db-4120-819f-fccba0dcf4b1
# ╠═10a9e4e6-401f-49fb-ade6-2b85f67f4cf1
